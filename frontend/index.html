<!doctype html>
<html lang="zh-CN">
<head>
  <meta charset="utf-8"/>
  <title>Amazonq2api 前端控制台 · 账号管理 + Chat 测试</title>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <style>
    :root {
      --bg:#0a0e1a;
      --panel:#0f1420;
      --muted:#8b95a8;
      --text:#e8f0ff;
      --accent:#4f8fff;
      --danger:#ff4757;
      --ok:#2ed573;
      --warn:#ffa502;
      --border:#1a2332;
      --chip:#141b28;
      --code:#0d1218;
      --glow:rgba(79,143,255,.15);
    }
    * { box-sizing:border-box; }
    html, body { height:100%; margin:0; }
    body {
      padding:0 0 40px;
      background:radial-gradient(ellipse at top, #0f1624 0%, #0a0e1a 100%);
      color:var(--text);
      font-family:ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,PingFang SC,Hiragino Sans GB,Microsoft YaHei,Noto Sans,Arial,sans-serif;
      line-height:1.6;
    }
    h1,h2,h3 { font-weight:700; letter-spacing:-.02em; margin:0; }
    h1 { font-size:28px; margin:24px 0 12px; background:linear-gradient(135deg,#4f8fff,#7b9fff); -webkit-background-clip:text; -webkit-text-fill-color:transparent; background-clip:text; }
    h2 { font-size:18px; margin:20px 0 16px; color:#c5d4ff; }
    h3 { font-size:15px; margin:16px 0 10px; color:#a8b8d8; }
    .container { max-width:1280px; margin:0 auto; padding:20px; }
    .grid { display:grid; grid-template-columns:1fr 1fr; gap:20px; }
    @media(max-width:1024px){ .grid { grid-template-columns:1fr; } }
    .panel {
      background:linear-gradient(145deg,rgba(15,20,32,.8),rgba(10,14,26,.9));
      border:1px solid var(--border);
      border-radius:16px;
      padding:24px;
      box-shadow:0 20px 60px rgba(0,0,0,.4),0 0 0 1px rgba(79,143,255,.08),inset 0 1px 0 rgba(255,255,255,.03);
      backdrop-filter:blur(12px);
      transition:transform .2s,box-shadow .2s;
    }
    .panel:hover { transform:translateY(-2px); box-shadow:0 24px 70px rgba(0,0,0,.5),0 0 0 1px rgba(79,143,255,.12),inset 0 1px 0 rgba(255,255,255,.04); }
    .row { display:flex; gap:12px; align-items:center; flex-wrap:wrap; }
    label { color:var(--muted); font-size:13px; font-weight:500; letter-spacing:.01em; }
    .field { display:flex; flex-direction:column; gap:8px; flex:1; min-width:200px; }
    input,textarea,select {
      background:rgba(12,16,28,.6);
      color:var(--text);
      border:1px solid var(--border);
      border-radius:12px;
      padding:12px 14px;
      outline:none;
      transition:all .2s;
      font-size:14px;
      box-shadow:inset 0 1px 2px rgba(0,0,0,.2);
    }
    input:focus,textarea:focus,select:focus {
      border-color:var(--accent);
      box-shadow:0 0 0 3px var(--glow),inset 0 1px 2px rgba(0,0,0,.2);
      background:rgba(12,16,28,.8);
    }
    textarea { min-height:140px; resize:vertical; font-family:ui-monospace,monospace; }
    button {
      background:linear-gradient(135deg,#2563eb,#1e40af);
      color:#fff;
      border:none;
      border-radius:12px;
      padding:12px 20px;
      font-weight:600;
      font-size:14px;
      cursor:pointer;
      transition:all .2s;
      box-shadow:0 4px 16px rgba(37,99,235,.3),inset 0 1px 0 rgba(255,255,255,.1);
      position:relative;
      overflow:hidden;
    }
    button:before {
      content:'';
      position:absolute;
      top:0;left:0;right:0;bottom:0;
      background:linear-gradient(135deg,rgba(255,255,255,.1),transparent);
      opacity:0;
      transition:opacity .2s;
    }
    button:hover { transform:translateY(-1px); box-shadow:0 6px 20px rgba(37,99,235,.4),inset 0 1px 0 rgba(255,255,255,.15); }
    button:hover:before { opacity:1; }
    button:active { transform:translateY(0); }
    button:disabled { opacity:.5; cursor:not-allowed; transform:none; }
    .btn-secondary { background:linear-gradient(135deg,#1e293b,#0f172a); box-shadow:0 4px 16px rgba(15,23,42,.3),inset 0 1px 0 rgba(255,255,255,.05); }
    .btn-secondary:hover { box-shadow:0 6px 20px rgba(15,23,42,.4),inset 0 1px 0 rgba(255,255,255,.08); }
    .btn-danger { background:linear-gradient(135deg,#dc2626,#991b1b); box-shadow:0 4px 16px rgba(220,38,38,.3),inset 0 1px 0 rgba(255,255,255,.1); }
    .btn-danger:hover { box-shadow:0 6px 20px rgba(220,38,38,.4),inset 0 1px 0 rgba(255,255,255,.15); }
    .btn-warn { background:linear-gradient(135deg,#f59e0b,#d97706); box-shadow:0 4px 16px rgba(245,158,11,.3),inset 0 1px 0 rgba(255,255,255,.1); }
    .btn-warn:hover { box-shadow:0 6px 20px rgba(245,158,11,.4),inset 0 1px 0 rgba(255,255,255,.15); }
    .kvs { display:grid; grid-template-columns:160px 1fr; gap:10px 16px; font-size:13px; }
    .muted { color:var(--muted); }
    .chip {
      display:inline-flex;
      align-items:center;
      gap:6px;
      padding:6px 12px;
      background:rgba(20,27,40,.8);
      border:1px solid var(--border);
      border-radius:20px;
      color:#a8b8ff;
      font-size:12px;
      font-weight:500;
      box-shadow:0 2px 8px rgba(0,0,0,.2);
    }
    .list { position:relative; max-height:75vh; overflow:auto; padding:2px; }
    .list::-webkit-scrollbar { width:8px; }
    .list::-webkit-scrollbar-track { background:rgba(0,0,0,.2); border-radius:4px; }
    .list::-webkit-scrollbar-thumb { background:rgba(79,143,255,.3); border-radius:4px; }
    .list::-webkit-scrollbar-thumb:hover { background:rgba(79,143,255,.5); }

    /* 卡片网格布局 */
    .account-grid {
      display:grid;
      grid-template-columns:repeat(4, minmax(0, 1fr));
      gap:12px;
      padding:12px 0;
    }
    @media (max-width:1400px) { .account-grid { grid-template-columns:repeat(3, minmax(0, 1fr)); } }
    @media (max-width:1024px) { .account-grid { grid-template-columns:repeat(2, minmax(0, 1fr)); } }
    @media (max-width:640px) { .account-grid { grid-template-columns:1fr; } }

    /* 卡片样式 - 16:9比例 */
    .account-card {
      position:relative;
      display:flex;
      flex-direction:column;
      gap:6px;
      padding:10px 12px;
      border-radius:10px;
      border:1px solid var(--border);
      background:linear-gradient(145deg,rgba(12,19,34,.7),rgba(10,14,26,.85));
      box-shadow:0 2px 10px rgba(0,0,0,.3);
      aspect-ratio:16/9;
      box-sizing:border-box;
      font-size:12px;
      transition:all .2s;
      overflow:hidden;
    }
    .account-card:hover { border-color:rgba(79,143,255,.4); box-shadow:0 4px 16px rgba(0,0,0,.4); transform:translateY(-2px); }
    .account-card--disabled { opacity:.55; }

    .account-card__header {
      display:flex;
      align-items:flex-start;
      justify-content:space-between;
      gap:8px;
    }
    .account-card__title { min-width:0; flex:1; }
    .account-label {
      font-weight:600;
      font-size:13px;
      color:var(--text);
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
    }
    .account-id {
      margin-top:2px;
      font-size:10px;
      color:var(--muted);
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
      font-family:ui-monospace,monospace;
    }

    /* 紧凑开关 */
    .account-toggle {
      display:inline-flex;
      align-items:center;
      gap:4px;
      cursor:pointer;
      font-size:10px;
      color:var(--muted);
      flex-shrink:0;
    }
    .account-toggle input { display:none; }
    .account-toggle__slider {
      width:28px;
      height:14px;
      border-radius:999px;
      background:#374151;
      position:relative;
      transition:background .15s;
    }
    .account-toggle__slider::before {
      content:"";
      position:absolute;
      top:2px;
      left:2px;
      width:10px;
      height:10px;
      border-radius:999px;
      background:#fff;
      transition:transform .15s;
    }
    .account-toggle input:checked + .account-toggle__slider { background:var(--ok); }
    .account-toggle input:checked + .account-toggle__slider::before { transform:translateX(14px); }

    /* 中间统计 */
    .account-card__body { flex:1; display:flex; align-items:center; }
    .account-stats { display:flex; gap:16px; }
    .stat { display:flex; flex-direction:column; gap:1px; }
    .stat-label { font-size:10px; color:var(--muted); }
    .stat-value { font-weight:600; font-size:14px; }
    .stat--success .stat-value { color:var(--ok); }
    .stat--error .stat-value { color:var(--danger); }

    /* 底部按钮 */
    .account-card__footer { display:flex; justify-content:flex-end; gap:6px; align-items:center; }
    
    /* 最大退避指示灯 */
    .throttle-indicator {
      position:absolute;
      bottom:10px;
      left:12px;
      width:8px;
      height:8px;
      border-radius:50%;
      background:var(--warn);
      animation:breathe 2s ease-in-out infinite;
      cursor:help;
    }
    @keyframes breathe {
      0%, 100% { opacity:0.4; box-shadow:0 0 4px var(--warn); }
      50% { opacity:1; box-shadow:0 0 10px var(--warn), 0 0 20px rgba(255,165,2,.4); }
    }
    
    .card-btn {
      border-radius:4px;
      border:1px solid transparent;
      padding:3px 8px;
      font-size:10px;
      line-height:1.4;
      cursor:pointer;
      background:rgba(255,255,255,.08);
      color:var(--text);
      transition:all .15s;
    }
    .card-btn:hover { background:rgba(255,255,255,.15); }
    .card-btn--warn { border-color:rgba(255,165,2,.4); color:var(--warn); }
    .card-btn--warn:hover { background:rgba(255,165,2,.15); }
    .card-btn--danger { border-color:rgba(255,71,87,.4); color:var(--danger); }
    .card-btn--danger:hover { background:rgba(255,71,87,.15); }
    .mono { font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,monospace; }
    .code {
      background:var(--code);
      border:1px solid var(--border);
      border-radius:12px;
      padding:14px;
      color:#d8e8ff;
      max-height:300px;
      overflow:auto;
      white-space:pre-wrap;
      font-size:13px;
      line-height:1.6;
      box-shadow:inset 0 2px 4px rgba(0,0,0,.3);
    }
    .code::-webkit-scrollbar { width:8px; height:8px; }
    .code::-webkit-scrollbar-track { background:rgba(0,0,0,.2); border-radius:4px; }
    .code::-webkit-scrollbar-thumb { background:rgba(79,143,255,.3); border-radius:4px; }
    .right { margin-left:auto; }
    .sep { height:1px; background:linear-gradient(90deg,transparent,rgba(79,143,255,.2),transparent); margin:16px 0; }
    .status-ok { color:var(--ok); font-weight:600; }
    .status-fail { color:var(--danger); font-weight:600; }
    .switch { position:relative; display:inline-block; width:50px; height:26px; }
    .switch input { opacity:0; width:0; height:0; }
    .slider {
      position:absolute;
      cursor:pointer;
      top:0;left:0;right:0;bottom:0;
      background:linear-gradient(135deg,#374151,#1f2937);
      transition:.3s;
      border-radius:26px;
      border:1px solid var(--border);
      box-shadow:inset 0 2px 4px rgba(0,0,0,.3);
    }
    .slider:before {
      position:absolute;
      content:"";
      height:20px;
      width:20px;
      left:3px;
      bottom:2px;
      background:linear-gradient(135deg,#f3f4f6,#e5e7eb);
      transition:.3s;
      border-radius:50%;
      box-shadow:0 2px 6px rgba(0,0,0,.3);
    }
    input:checked+.slider { background:linear-gradient(135deg,#3b82f6,#2563eb); box-shadow:0 0 12px rgba(59,130,246,.4),inset 0 2px 4px rgba(0,0,0,.2); }
    input:checked+.slider:before { transform:translateX(24px); }
    @keyframes fadeIn { from { opacity:0; transform:translateY(10px); } to { opacity:1; transform:translateY(0); } }
    .panel { animation:fadeIn .4s ease-out; }
    .tabs { display:flex; gap:8px; margin:20px 0 16px; border-bottom:2px solid var(--border); }
    .tab { padding:12px 24px; background:transparent; border:none; color:var(--muted); font-weight:600; font-size:14px; cursor:pointer; border-bottom:2px solid transparent; margin-bottom:-2px; transition:all .2s; }
    .tab:hover { color:var(--text); background:rgba(79,143,255,.05); }
    .tab.active { color:var(--accent); border-bottom-color:var(--accent); }
    .tab-content { display:none; }
    .tab-content.active { display:block; }
    .topbar { display:flex; align-items:center; gap:12px; margin-top:12px; }
    .badges { margin-left:auto; display:flex; align-items:center; gap:10px; flex-wrap:wrap; }
    .chip-btn { cursor:pointer; border:1px solid var(--border); background:var(--chip); }
    .chip-ok { color:var(--ok); border-color:rgba(46,213,115,.4); }
    .chip-warn { color:var(--warn); border-color:rgba(255,165,2,.4); }
    .chip-muted { color:var(--muted); }
    .spin { display:inline-block; width:12px; height:12px; border:2px solid rgba(255,255,255,.3); border-top-color:var(--accent); border-radius:50%; animation:spin 1s linear infinite; margin-left:6px; }
    @keyframes spin { to { transform:rotate(360deg); } }
    .log-controls { display:flex; gap:12px; align-items:center; flex-wrap:wrap; }

    /* 标题统计小卡片 */
    .stats-mini { display:flex; gap:8px; margin-left:16px; }
    .stat-mini {
      display:flex;
      align-items:center;
      gap:4px;
      padding:4px 10px;
      background:rgba(20,27,40,.8);
      border:1px solid var(--border);
      border-radius:6px;
      font-size:12px;
    }
    .stat-mini__label { color:var(--muted); }
    .stat-mini__value { font-weight:600; font-family:ui-monospace,monospace; }
    .stat-mini--total .stat-mini__value { color:var(--accent); }
    .stat-mini--success .stat-mini__value { color:var(--ok); }
    .stat-mini--error .stat-mini__value { color:var(--danger); }

    /* 模型统计卡片行 */
    .model-stats-row {
      display:flex;
      gap:8px;
      flex-wrap:wrap;
      margin:8px 0;
    }
    .model-stat-card {
      display:flex;
      align-items:center;
      gap:10px;
      padding:4px 12px;
      background:rgba(20,27,40,.8);
      border:1px solid var(--border);
      border-radius:6px;
      font-size:12px;
    }
    .model-stat-card__name {
      font-weight:600;
      color:var(--text);
      max-width:120px;
      overflow:hidden;
      text-overflow:ellipsis;
      white-space:nowrap;
    }
    .model-stat-card__stats {
      display:flex;
      gap:8px;
    }
    .model-stat-card__item {
      display:flex;
      align-items:center;
      gap:3px;
    }
    .model-stat-card__label { color:var(--muted); }
    .model-stat-card__value { font-weight:600; font-family:ui-monospace,monospace; }
    .model-stat-card__value--total { color:var(--accent); }
    .model-stat-card__value--success { color:var(--ok); }
    .model-stat-card__value--error { color:var(--danger); }

    /* 日志条目样式 */
    .log-list { 
      display:block;
      height:60vh;
      max-height:60vh; 
      overflow-y:auto; 
      overflow-x:hidden;
      padding:4px 0; 
    }
    .log-item {
      border:1px solid var(--border);
      border-radius:8px;
      background:rgba(12,19,34,.6);
      overflow:hidden;
      margin-bottom:8px;
      flex-shrink:0;
    }
    .log-item--error { border-left:3px solid var(--danger); }
    .log-summary {
      display:flex;
      align-items:center;
      gap:8px;
      padding:8px 12px;
      cursor:pointer;
      font-size:12px;
      list-style:none;
    }
    .log-summary::-webkit-details-marker { display:none; }
    .log-summary::before {
      content:'▶';
      font-size:10px;
      color:var(--muted);
      transition:transform .15s;
      flex-shrink:0;
    }
    .log-item[open] .log-summary::before { transform:rotate(90deg); }
    .log-meta { color:var(--muted); font-size:11px; white-space:nowrap; flex-shrink:0; }
    .log-title { flex:1; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; font-family:ui-monospace,monospace; }
    .log-summary--error .log-title { color:var(--danger); font-weight:600; }
    .log-summary--request .log-title { color:var(--ok); font-weight:600; }
    .log-item--request { border-left:3px solid var(--ok); }
    .log-copy {
      border:1px solid var(--border);
      border-radius:4px;
      padding:2px 8px;
      font-size:10px;
      background:rgba(255,255,255,.06);
      color:var(--muted);
      cursor:pointer;
      flex-shrink:0;
      transition:all .15s;
    }
    .log-copy:hover { background:rgba(255,255,255,.12); color:var(--text); }
    .log-body {
      margin:0;
      padding:10px 12px;
      background:var(--code);
      border-top:1px solid var(--border);
      white-space:pre-wrap;
      font-size:12px;
      font-family:ui-monospace,monospace;
      color:#d8e8ff;
      max-height:70vh;
      overflow:auto;
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="topbar">
      <h1>Q2api 前端控制台</h1>
      <div class="stats-mini">
        <div class="stat-mini stat-mini--total">
          <span class="stat-mini__label">总请求</span>
          <span class="stat-mini__value" id="stats_total">0</span>
        </div>
        <div class="stat-mini stat-mini--success">
          <span class="stat-mini__label">成功</span>
          <span class="stat-mini__value" id="stats_success">0</span>
        </div>
        <div class="stat-mini stat-mini--error">
          <span class="stat-mini__label">失败</span>
          <span class="stat-mini__value" id="stats_error">0</span>
        </div>
      </div>
      <div class="badges">
        <div id="storage_badge" class="chip chip-muted">DB: --</div>
        <button id="ip_badge" class="chip chip-btn" onclick="loadEgressIp(true)">IP: --</button>
      </div>
    </div>

    <!-- 模型统计卡片区域 -->
    <div id="model_stats_container" class="model-stats-row"></div>

    <div class="tabs">
      <button class="tab active" onclick="switchTab('accounts')">账号管理</button>
      <button class="tab" onclick="switchTab('create')">创建账号</button>
      <button class="tab" onclick="switchTab('login')">URL登录</button>
      <button class="tab" onclick="switchTab('chat')">Chat测试</button>
      <button class="tab" onclick="switchTab('logs')">日志</button>
    </div>

    <div id="tab-accounts" class="tab-content active">
      <div class="panel">
        <h2>账号管理 <span id="accountCount" style="font-size: 0.8em; color: #666;"></span></h2>
        <div class="row">
          <button class="btn-secondary" onclick="loadAccounts()">刷新列表</button>
          <div style="margin-left: 20px;">
            <label><input type="radio" name="accountFilter" value="all" checked onchange="loadAccounts()"> 全部</label>
            <label style="margin-left: 10px;"><input type="radio" name="accountFilter" value="enabled" onchange="loadAccounts()"> 已启用</label>
            <label style="margin-left: 10px;"><input type="radio" name="accountFilter" value="disabled" onchange="loadAccounts()"> 已禁用</label>
          </div>
          <div style="margin-left: 20px;">
            <label>排序：
              <select id="sortBy" onchange="loadAccounts()">
                <option value="created_at">创建日期</option>
                <option value="success_count">成功次数</option>
              </select>
            </label>
            <label style="margin-left: 10px;">
              <select id="sortOrder" onchange="loadAccounts()">
                <option value="desc">降序</option>
                <option value="asc">升序</option>
              </select>
            </label>
          </div>
        </div>
        <div class="list" id="accounts"></div>
      </div>
    </div>

    <div id="tab-create" class="tab-content">
      <div class="panel">
        <h2>创建账号</h2>
        <div class="row">
          <div class="field"><label>label</label><input id="new_label" /></div>
          <div class="field"><label>clientId</label><input id="new_clientId" /></div>
          <div class="field"><label>clientSecret</label><input id="new_clientSecret" /></div>
        </div>
        <div class="row">
          <div class="field"><label>refreshToken</label><input id="new_refreshToken" /></div>
          <div class="field"><label>accessToken</label><input id="new_accessToken" /></div>
        </div>
        <div class="row">
          <div class="field">
            <label>other（JSON，可选）</label>
            <textarea id="new_other" placeholder='{"note":"备注"}'></textarea>
          </div>
          <div class="field" style="max-width:220px">
            <label>启用（仅启用账号会被用于请求）</label>
            <div>
              <label class="switch">
                <input id="new_enabled" type="checkbox" checked />
                <span class="slider"></span>
              </label>
            </div>
          </div>
        </div>
        <div class="row">
          <button onclick="createAccount()">创建</button>
        </div>
      </div>
    </div>

    <div id="tab-login" class="tab-content">
      <div class="panel">
        <h2>URL 登录（5分钟超时）</h2>
        <div class="row">
          <div class="field"><label>label（可选）</label><input id="auth_label" /></div>
          <div class="field" style="max-width:220px">
            <label>启用（登录成功后新账号是否启用）</label>
            <div>
              <label class="switch">
                <input id="auth_enabled" type="checkbox" checked />
                <span class="slider"></span>
              </label>
            </div>
          </div>
        </div>
        <div class="row">
          <button onclick="startAuth()">一键登录并创建账号</button>
        </div>
        <div class="field">
          <label>登录信息</label>
          <pre class="code mono" id="auth_info">尚未开始</pre>
        </div>
      </div>
    </div>

    <div id="tab-chat" class="tab-content">
      <div class="panel">
        <h2>Chat 测试（OpenAI 兼容 /v1/chat/completions）</h2>
        <div class="row">
          <div class="field" style="max-width:300px">
            <label>model</label>
            <input id="model" value="claude-sonnet-4" />
          </div>
          <div class="field" style="max-width:180px">
            <label>是否流式</label>
            <select id="stream">
              <option value="false">false（默认）</option>
              <option value="true">true（SSE）</option>
            </select>
          </div>
          <button class="right" onclick="send()">发送请求</button>
        </div>
        <div class="field">
          <label>messages（JSON）</label>
          <textarea id="messages">[
  {"role":"system","content":"你是一个乐于助人的助手"},
  {"role":"user","content":"你好，请讲一个简短的故事"}
]</textarea>
        </div>
        <div class="field">
          <label>响应</label>
          <pre class="code mono" id="out"></pre>
        </div>
      </div>
    </div>

    <div id="tab-logs" class="tab-content">
      <div class="panel">
        <h2>日志查看（print 采集）</h2>
        <div class="log-controls">
          <div class="row" style="gap:8px; align-items:center;">
            <label>捕获开关</label>
            <label class="switch">
              <input id="log_capture_toggle" type="checkbox" onchange="toggleLogCapture()" />
              <span class="slider"></span>
            </label>
          </div>
          <div class="row" style="gap:8px; align-items:center;">
            <label>显示请求</label>
            <label class="switch">
              <input id="log_request_toggle" type="checkbox" onchange="toggleRequestLogging()" />
              <span class="slider"></span>
            </label>
          </div>
          <div class="row" style="gap:8px; align-items:center;">
            <label>自动刷新</label>
            <label class="switch">
              <input id="log_auto_toggle" type="checkbox" onchange="toggleLogAuto()" checked />
              <span class="slider"></span>
            </label>
          </div>
          <button class="btn-secondary" onclick="refreshLogs(true)">手动刷新</button>
          <button class="btn-secondary" onclick="clearLogs()">清空显示</button>
        </div>
        <div class="field" style="min-height:0; flex:none;">
          <label>实时日志（最新在上，点击展开详情）</label>
          <div class="log-list" id="log_output"></div>
        </div>
      </div>
    </div>
  </div>


<script>
function switchTab(name) {
  document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
  document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
  event.target.classList.add('active');
  document.getElementById('tab-' + name).classList.add('active');
  if (name === 'logs') {
    startLogPolling();
  } else {
    stopLogPolling();
  }
}

function api(path){
  const pathClean = ('/' + (path || '').replace(/^\/+/, '')).replace(/\/{2,}/g, '/');
  return pathClean;
}

// Authentication helpers
function getAuthPassword() {
  return localStorage.getItem('adminPassword');
}

function getAuthHeaders() {
  const password = getAuthPassword();
  if (!password) return {};
  return { 'Authorization': `Bearer ${password}` };
}

// Authenticated fetch wrapper
async function authFetch(url, options = {}) {
  const headers = { ...getAuthHeaders(), ...options.headers };
  const response = await fetch(url, { ...options, headers });

  if (response.status === 401) {
    localStorage.removeItem('adminPassword');
    window.location.href = '/login';
    throw new Error('Unauthorized');
  }

  return response;
}

// Logs view
let logLastSeq = 0;
let logPollTimer = null;
let logAuto = true;
let logSeenSeqs = new Set();

// Error detection
function isErrorLog(text) {
  return /\b(error|exception|traceback|fail(ed)?|critical|fatal|错误|失败|Traceback)\b/i.test(text);
}

// Escape HTML
function escapeHtml(str) {
  return str.replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;');
}

// Format timestamp to East 8 timezone (UTC+8)
function formatLogTs(ts) {
  const d = new Date((ts || 0) * 1000);
  // Convert to UTC+8
  const utc8 = new Date(d.getTime() + 8 * 60 * 60 * 1000);
  const year = utc8.getUTCFullYear();
  const month = String(utc8.getUTCMonth() + 1).padStart(2, '0');
  const day = String(utc8.getUTCDate()).padStart(2, '0');
  const hour = String(utc8.getUTCHours()).padStart(2, '0');
  const min = String(utc8.getUTCMinutes()).padStart(2, '0');
  const sec = String(utc8.getUTCSeconds()).padStart(2, '0');
  return `${year}-${month}-${day} ${hour}:${min}:${sec}`;
}

// Create log entry element
function createLogEntry(e) {
  const isRequest = e.kind === 'request';
  const isError = e.kind === 'error' || isErrorLog(e.text);
  const firstLine = (e.text || '').split('\n')[0] || '(空)';
  
  const details = document.createElement('details');
  let itemClass = 'log-item';
  if (isRequest) itemClass += ' log-item--request';
  else if (isError) itemClass += ' log-item--error';
  details.className = itemClass;
  details.dataset.seq = e.seq;
  details.dataset.kind = e.kind || 'log';
  
  const summary = document.createElement('summary');
  let summaryClass = 'log-summary';
  if (isRequest) summaryClass += ' log-summary--request';
  else if (isError) summaryClass += ' log-summary--error';
  summary.className = summaryClass;
  
  const meta = document.createElement('span');
  meta.className = 'log-meta';
  meta.textContent = '#' + e.seq + ' · ' + formatLogTs(e.ts);
  
  const title = document.createElement('span');
  title.className = 'log-title';
  title.textContent = firstLine;
  
  const copyBtn = document.createElement('button');
  copyBtn.type = 'button';
  copyBtn.className = 'log-copy';
  copyBtn.textContent = '复制';
  
  summary.appendChild(meta);
  summary.appendChild(title);
  summary.appendChild(copyBtn);
  
  const body = document.createElement('pre');
  body.className = 'log-body';
  body.textContent = e.text;
  
  details.appendChild(summary);
  details.appendChild(body);
  
  return details;
}

// Clear logs display
function clearLogs() {
  const out = document.getElementById('log_output');
  if (out) out.innerHTML = '';
  logSeenSeqs.clear();
}

async function toggleLogCapture(){
  const toggle = document.getElementById('log_capture_toggle');
  if (!toggle) return;
  const enabled = toggle.checked;
  try{
    const r = await authFetch(api('/v2/meta/logs/toggle'), {
      method:'POST',
      headers:{'content-type':'application/json'},
      body: JSON.stringify({ enabled })
    });
    const j = await r.json();
    toggle.checked = !!j.enabled;
    if (toggle.checked) {
      startLogPolling();
    } else {
      stopLogPolling();
    }
  } catch(e){
    alert('切换失败：' + e);
    toggle.checked = !enabled;
  }
}

async function toggleRequestLogging(){
  const toggle = document.getElementById('log_request_toggle');
  if (!toggle) return;
  const enabled = toggle.checked;
  try{
    const r = await authFetch(api('/v2/meta/logs/requests/toggle'), {
      method:'POST',
      headers:{'content-type':'application/json'},
      body: JSON.stringify({ enabled })
    });
    const j = await r.json();
    toggle.checked = !!j.enabled;
  } catch(e){
    alert('切换失败：' + e);
    toggle.checked = !enabled;
  }
}

function startLogPolling(){
  stopLogPolling();
  if (!logAuto) return;
  refreshLogs();
  logPollTimer = setInterval(refreshLogs, 2000);
}

function stopLogPolling(){
  if (logPollTimer){
    clearInterval(logPollTimer);
    logPollTimer = null;
  }
}

function toggleLogAuto(){
  const t = document.getElementById('log_auto_toggle');
  logAuto = t ? !!t.checked : true;
  if (logAuto) {
    startLogPolling();
  } else {
    stopLogPolling();
  }
}

async function refreshLogs(manual=false){
  const out = document.getElementById('log_output');
  if (!out) return;
  try {
    const r = await authFetch(api(`/v2/meta/logs?after=${logLastSeq}&limit=300`));
    const j = await r.json();
    if (Array.isArray(j.logs) && j.logs.length > 0){
      // Sort by timestamp descending (millisecond precision, newest first)
      const sorted = j.logs.slice().sort((a, b) => b.ts - a.ts);
      
      sorted.forEach(e => {
        if (logSeenSeqs.has(e.seq)) return;
        logSeenSeqs.add(e.seq);
        logLastSeq = Math.max(logLastSeq, e.seq || 0);
        
        const entry = createLogEntry(e);
        out.prepend(entry);
      });
      
      // Limit displayed entries to 500
      while (out.children.length > 500) {
        const last = out.lastChild;
        if (last) {
          const seq = parseInt(last.dataset.seq);
          if (!isNaN(seq)) logSeenSeqs.delete(seq);
          out.removeChild(last);
        }
      }
    }
    const toggle = document.getElementById('log_capture_toggle');
    if (toggle) toggle.checked = !!j.enabled;
    const reqToggle = document.getElementById('log_request_toggle');
    if (reqToggle) reqToggle.checked = !!j.request_logging_enabled;
  } catch(e){
    if (manual) alert('日志刷新失败：' + e);
  }
}

// Log copy event delegation
document.addEventListener('DOMContentLoaded', () => {
  const logList = document.getElementById('log_output');
  if (logList) {
    logList.addEventListener('click', async (evt) => {
      const btn = evt.target.closest('.log-copy');
      if (!btn) return;
      evt.preventDefault();
      evt.stopPropagation();
      
      const details = btn.closest('.log-item');
      const body = details?.querySelector('.log-body');
      if (!body) return;
      
      try {
        await navigator.clipboard.writeText(body.textContent);
        const orig = btn.textContent;
        btn.textContent = '已复制';
        setTimeout(() => { btn.textContent = orig; }, 1500);
      } catch(e) {
        alert('复制失败：' + e);
      }
    });
  }
});

async function loadStorageStatus(){
  const el = document.getElementById('storage_badge');
  if (!el) return;
  el.textContent = 'DB: 加载中...';
  try {
    const r = await authFetch(api('/v2/meta/storage'));
    const j = await r.json();
    const backend = (j.backend || '未知').toLowerCase();
    const git = j.gitstore || {};

    let cls = 'chip chip-muted';
    let txt = 'DB: ' + (j.backend || '未知');

    if (backend === 'sqlite') {
      if (git.enabled) {
        const m = git.mode || 'UNKNOWN';
        txt += ' · gitstore ' + m;
        if (git.pending) txt += ' (pending)';
        cls = m === 'ACTIVE' ? 'chip chip-ok' : m === 'DEGRADED' ? 'chip chip-warn' : 'chip chip-muted';
      } else {
        txt += ' · 本地';
      }
    }

    if (git.error) {
      txt += ' ⚠';
      el.title = git.error;
    } else {
      el.removeAttribute('title');
    }

    el.className = cls;
    el.textContent = txt;

    // 为 DEGRADED 或 LOCAL 状态添加点击重连功能
    if (backend === 'sqlite' && git.enabled && (git.mode === 'DEGRADED' || git.mode === 'LOCAL')) {
      el.style.cursor = 'pointer';
      el.onclick = async () => {
        el.textContent = txt + ' (重连中...)';
        el.style.cursor = 'wait';
        try {
          const resp = await authFetch(api('/v2/gitstore/reconnect'), { method: 'POST' });
          const result = await resp.json();
          if (result.success) {
            showToast('Gitstore 重连成功', 'success');
          } else {
            showToast('重连失败: ' + (result.error || '未知错误'), 'error');
          }
        } catch (err) {
          showToast('重连请求失败: ' + err.message, 'error');
        }
        loadStorageInfo(); // 刷新状态
      };
    } else {
      el.style.cursor = 'default';
      el.onclick = null;
    }
  } catch (e) {
    el.className = 'chip chip-warn';
    el.textContent = 'DB: 获取失败';
  }
}

async function loadEgressIp(manual=false){
  const el = document.getElementById('ip_badge');
  if (!el) return;
  el.innerHTML = 'IP: 刷新中...';
  el.removeAttribute('title');
  try {
    const r = await authFetch(api('/v2/meta/egress_ip'));
    const j = await r.json();
    let txt = 'IP: ' + (j.ip || '未知');
    if (j.country || j.city) {
      const loc = [j.country, j.city].filter(Boolean).join(' · ');
      if (loc) txt += ' (' + loc + ')';
      el.title = loc;
    }
    if (j.geo_pending && !(j.country || j.city)) {
      el.innerHTML = txt + ' <span class="spin"></span>';
    } else {
      el.innerHTML = txt;
    }
  } catch (e) {
    el.textContent = 'IP: 获取失败';
  }
}

// Check authentication on page load - removed, combined with loadAccounts below

// Virtual scroll state
let accountsData = [];
// Create compact account card element (16:9)
function createAccountCard(acc) {
  const card = document.createElement('article');
  card.className = 'account-card' + (acc.enabled ? '' : ' account-card--disabled');
  card.dataset.accountId = acc.id;

  // Header: title + toggle
  const header = document.createElement('header');
  header.className = 'account-card__header';

  const titleDiv = document.createElement('div');
  titleDiv.className = 'account-card__title';
  const labelEl = document.createElement('div');
  labelEl.className = 'account-label';
  labelEl.textContent = acc.label || '(无标签)';
  labelEl.title = acc.label || '';
  const idEl = document.createElement('div');
  idEl.className = 'account-id';
  idEl.textContent = acc.id;
  idEl.title = acc.id;
  titleDiv.appendChild(labelEl);
  titleDiv.appendChild(idEl);

  // Toggle
  const toggle = document.createElement('label');
  toggle.className = 'account-toggle';
  const toggleText = document.createElement('span');
  toggleText.className = 'account-toggle__label';
  toggleText.textContent = '启用';
  const chk = document.createElement('input');
  chk.type = 'checkbox';
  chk.checked = !!acc.enabled;
  chk.onchange = async () => {
    try {
      await updateAccount(acc.id, { enabled: chk.checked });
    } catch(e) {
      chk.checked = !chk.checked;
    }
  };
  const slider = document.createElement('span');
  slider.className = 'account-toggle__slider';
  toggle.appendChild(toggleText);
  toggle.appendChild(chk);
  toggle.appendChild(slider);

  header.appendChild(titleDiv);
  header.appendChild(toggle);
  card.appendChild(header);

  // Body: stats
  const body = document.createElement('div');
  body.className = 'account-card__body';
  const stats = document.createElement('div');
  stats.className = 'account-stats';

  function createStat(label, value, type) {
    const stat = document.createElement('div');
    stat.className = 'stat stat--' + type;
    const statLabel = document.createElement('span');
    statLabel.className = 'stat-label';
    statLabel.textContent = label;
    const statValue = document.createElement('span');
    statValue.className = 'stat-value';
    statValue.textContent = value ?? 0;
    stat.appendChild(statLabel);
    stat.appendChild(statValue);
    return stat;
  }

  stats.appendChild(createStat('成功', acc.success_count, 'success'));
  stats.appendChild(createStat('失败', acc.error_count, 'error'));
  body.appendChild(stats);
  card.appendChild(body);

  // Footer: buttons
  const footer = document.createElement('footer');
  footer.className = 'account-card__footer';

  const refreshBtn = document.createElement('button');
  refreshBtn.className = 'card-btn card-btn--warn';
  refreshBtn.textContent = '刷新';
  refreshBtn.onclick = (e) => { e.stopPropagation(); refreshAccount(acc.id); };

  const delBtn = document.createElement('button');
  delBtn.className = 'card-btn card-btn--danger';
  delBtn.textContent = '删除';
  delBtn.onclick = (e) => { e.stopPropagation(); deleteAccount(acc.id); };

  footer.appendChild(refreshBtn);
  footer.appendChild(delBtn);
  card.appendChild(footer);

  // Throttle indicator (max level)
  if (acc.throttle_info && acc.throttle_info.is_max_level) {
    const indicator = document.createElement('div');
    indicator.className = 'throttle-indicator';
    indicator.title = '指数退避等级已达最高级别';
    card.appendChild(indicator);
  }

  return card;
}

function renderAccounts(list){
  accountsData = list;
  const root = document.getElementById('accounts');
  root.innerHTML = '';
  
  if (!Array.isArray(list) || list.length === 0) {
    const empty = document.createElement('div');
    empty.className = 'muted';
    empty.textContent = '暂无账号';
    root.appendChild(empty);
    return;
  }
  
  const grid = document.createElement('div');
  grid.className = 'account-grid';
  
  list.forEach(acc => {
    grid.appendChild(createAccountCard(acc));
  });
  
  root.appendChild(grid);
}

async function loadAccounts(){
  try{
    const filter = document.querySelector('input[name="accountFilter"]:checked')?.value || 'all';
    const sortBy = document.getElementById('sortBy')?.value || 'created_at';
    const sortOrder = document.getElementById('sortOrder')?.value || 'desc';
    let url = '/v2/accounts?';
    const params = [];
    if (filter === 'enabled') params.push('enabled=true');
    else if (filter === 'disabled') params.push('enabled=false');
    params.push(`sort_by=${sortBy}`);
    params.push(`sort_order=${sortOrder}`);
    url += params.join('&');
    const r = await authFetch(api(url));
    const j = await r.json();
    document.getElementById('accountCount').textContent = `(${j.count})`;
    renderAccounts(j.accounts);
  } catch(e){
    alert('加载账户失败：' + e);
  }
}

async function createAccount(){
  const body = {
    label: document.getElementById('new_label').value.trim() || null,
    clientId: document.getElementById('new_clientId').value.trim(),
    clientSecret: document.getElementById('new_clientSecret').value.trim(),
    refreshToken: document.getElementById('new_refreshToken').value.trim() || null,
    accessToken: document.getElementById('new_accessToken').value.trim() || null,
    enabled: document.getElementById('new_enabled').checked,
    other: (()=>{
      const t = document.getElementById('new_other').value.trim();
      if (!t) return null;
      try { return JSON.parse(t); } catch { alert('other 不是合法 JSON'); throw new Error('bad other'); }
    })()
  };
  try{
    const r = await authFetch(api('/v2/accounts'), {
      method:'POST',
      headers:{ 'content-type':'application/json' },
      body: JSON.stringify(body)
    });
    if (!r.ok) {
      const t = await r.text();
      throw new Error(t);
    }
    await loadAccounts();
  } catch(e){
    alert('创建失败：' + e);
  }
}

async function deleteAccount(id){
  if (!confirm('确认删除该账号？')) return;
  try{
    const r = await authFetch(api('/v2/accounts/' + encodeURIComponent(id)), { method:'DELETE' });
    if (!r.ok) { throw new Error(await r.text()); }
    await loadAccounts();
  } catch(e){
    alert('删除失败：' + e);
  }
}

async function updateAccount(id, patch){
  try{
    const r = await authFetch(api('/v2/accounts/' + encodeURIComponent(id)), {
      method:'PATCH',
      headers:{ 'content-type':'application/json' },
      body: JSON.stringify(patch)
    });
    if (!r.ok) { throw new Error(await r.text()); }
    await loadAccounts();
  } catch(e){
    alert('更新失败：' + e);
  }
}

async function refreshAccount(id){
  try{
    const r = await authFetch(api('/v2/accounts/' + encodeURIComponent(id) + '/refresh'), { method:'POST' });
    if (!r.ok) { throw new Error(await r.text()); }
    await loadAccounts();
  } catch(e){
    alert('刷新失败：' + e);
  }
}

 // URL Login (Device Authorization)
 let currentAuth = null;
 async function startAuth(){
   const infoEl = document.getElementById('auth_info');
   infoEl.textContent = '正在启动登录...';
   
   const body = {
     label: (document.getElementById('auth_label').value || '').trim() || null,
     enabled: document.getElementById('auth_enabled').checked
   };
   try {
     const r = await authFetch(api('/v2/auth/start'), {
       method: 'POST',
       headers: { 'content-type': 'application/json' },
       body: JSON.stringify(body)
     });
     if (!r.ok) throw new Error(await r.text());
     const j = await r.json();
     currentAuth = j;
     const info = [
       '验证链接: ' + j.verificationUriComplete,
       '用户代码: ' + (j.userCode || ''),
       'authId: ' + j.authId,
       'expiresIn: ' + j.expiresIn + 's',
       'interval: ' + j.interval + 's',
       '',
       '⚠️ 重要：请务必在【隐私窗口/无痕模式】中打开上述链接！',
       '否则可能使用浏览器缓存的旧账号登录，导致授权失败。'
     ].join('\\n');
     infoEl.textContent = info;
     try {
       await navigator.clipboard.writeText(j.verificationUriComplete);
       infoEl.textContent += '\\n链接已复制到剪贴板！';
     } catch {}
     
     // 自动进入等待授权阶段
     await claimAuth();
   } catch(e){
     infoEl.textContent = '启动失败：' + e;
   }
 }

 async function claimAuth(){
   if (!currentAuth || !currentAuth.authId) {
     return;
   }
   const infoEl = document.getElementById('auth_info');
   const baseText = infoEl.textContent;
   
   // 动画效果：显示等待状态和倒计时
   let dots = 0;
   let seconds = 0;
   const maxSeconds = 300;
   const animInterval = setInterval(() => {
     dots = (dots + 1) % 4;
     seconds++;
     const remaining = Math.max(0, maxSeconds - seconds);
     const mins = Math.floor(remaining / 60);
     const secs = remaining % 60;
     const timeStr = mins > 0 ? mins + '分' + secs + '秒' : secs + '秒';
     const dotsStr = '.'.repeat(dots + 1);
     infoEl.textContent = baseText + '\\n\\n⏳ 正在等待授权' + dotsStr + ' (剩余 ' + timeStr + ')\\n请在隐私窗口中完成登录，不要关闭此页面';
   }, 1000);
   
   try{
     const r = await authFetch(api('/v2/auth/claim/' + encodeURIComponent(currentAuth.authId)), { method: 'POST' });
     clearInterval(animInterval);
     const text = await r.text();
     let j;
     try { j = JSON.parse(text); } catch { j = { raw: text }; }
     infoEl.textContent = '✅ 账号创建成功！\\n\\n' + JSON.stringify(j, null, 2);
     await loadAccounts();
   } catch(e){
     clearInterval(animInterval);
     const errMsg = String(e.message || e);
      let hint = '';
      if (errMsg.includes('not found') || errMsg.includes('404')) {
        hint = '\\n\\n可能原因：\\n1. 服务已重启，请重新点击按钮\\n2. 未在隐私窗口中打开链接，使用了缓存的旧账号';
      }
      infoEl.textContent = baseText + '\\n\\n❌ 失败：' + errMsg + hint;
   }
 }

async function send() {
  const model = document.getElementById('model').value.trim();
  const stream = document.getElementById('stream').value === 'true';
  const out = document.getElementById('out');
  out.textContent = '';

  let messages;
  try { messages = JSON.parse(document.getElementById('messages').value); }
  catch(e){ out.textContent = 'messages 不是合法 JSON'; return; }

  const body = { model, messages, stream };
  const headers = { 'content-type': 'application/json' };

  if (!stream) {
    const r = await authFetch(api('/v1/chat/completions'), {
      method:'POST',
      headers,
      body: JSON.stringify(body)
    });
    const text = await r.text();
    try { out.textContent = JSON.stringify(JSON.parse(text), null, 2); }
    catch { out.textContent = text; }
  } else {
    const r = await authFetch(api('/v1/chat/completions'), {
      method:'POST',
      headers,
      body: JSON.stringify(body)
    });
    const reader = r.body.getReader();
    const decoder = new TextDecoder();
    while (true) {
      const {value, done} = await reader.read();
      if (done) break;
      out.textContent += decoder.decode(value, {stream:true});
    }
  }
}

// Stats polling
let statsPollTimer = null;

async function loadStats() {
  try {
    const r = await authFetch(api('/v2/meta/stats'));
    const j = await r.json();
    document.getElementById('stats_total').textContent = j.total ?? 0;
    document.getElementById('stats_success').textContent = j.success ?? 0;
    document.getElementById('stats_error').textContent = j.error ?? 0;
    
    // Render model stats cards (only if there's data)
    const container = document.getElementById('model_stats_container');
    if (container && j.by_model) {
      const models = Object.keys(j.by_model).sort();
      if (models.length === 0) {
        container.innerHTML = '';
      } else {
        container.innerHTML = '';
        models.forEach(model => {
          const stats = j.by_model[model];
          const card = document.createElement('div');
          card.className = 'model-stat-card';
          card.innerHTML = `
            <span class="model-stat-card__name" title="${model}">${model}</span>
            <div class="model-stat-card__stats">
              <span class="model-stat-card__item">
                <span class="model-stat-card__label">总</span>
                <span class="model-stat-card__value model-stat-card__value--total">${stats.total ?? 0}</span>
              </span>
              <span class="model-stat-card__item">
                <span class="model-stat-card__label">成功</span>
                <span class="model-stat-card__value model-stat-card__value--success">${stats.success ?? 0}</span>
              </span>
              <span class="model-stat-card__item">
                <span class="model-stat-card__label">失败</span>
                <span class="model-stat-card__value model-stat-card__value--error">${stats.error ?? 0}</span>
              </span>
            </div>
          `;
          container.appendChild(card);
        });
      }
    }
  } catch(e) {
    // Silently fail
  }
}

function startStatsPolling() {
  loadStats();
  statsPollTimer = setInterval(loadStats, 5000);
}

window.addEventListener('DOMContentLoaded', () => {
  // Check authentication first
  const password = getAuthPassword();
  if (!password) {
    window.location.href = '/login';
    return;
  }
  // Only load accounts if authenticated
  loadStorageStatus();
  loadEgressIp();
  refreshLogs();
  loadAccounts();
  startStatsPolling();
});
</script>
</body>
</html>
